# 整合性とは

システムにはデータの整合性を求められる処理が存在する。

例えば、ユーザーIDがユニークでなければならないシステムにおいて、同時に同じユーザーIDで会員登録処理が行われた場合、ユーザーIDが重複したユーザーが作成されてしまう可能性がある。

データの整合性を保つために何かしらの戦略を練る必要がある。

# ユニークキー制約による防衛

ユニークキー制約は特定のカラムがユニークであることを保証する機能で、違反するレコードの挿入を行おうとするとエラーが発生する。

データの整合性を守るために積極的に利用すべき機能。

## ユニークキー制約を重複確認の主体としたときの問題点

ユニークキー制約はソフトウェアが破綻する危険性を排除する有力な方法だが、使い方を誤るとコードの表現力が奪われる。

ユニークキー制約さえ設定すれば、プログラムが不正を感知して終了するため重複確認をする必要がなくなり、以下のように簡略化するアイデアが浮かぶ。

```php
class UserApplicationService
{
    public function register(UserRegisterCommand $command)
    {
        $userName = new UserName($command->name);
        
        $user = $this->userFactory->create($userName);
        $this->userRepository->save($user);
    }
}
```

ユニークキー制約によってユーザ名が重複しないことは保証されているが、このコードからはユーザーには重複に関するルールが読み取れない。

また、ビジネスロジックが特定の技術基盤に依存することは避けるべきだが、重複しないことを担保する方法としてRDBのユニークキー制約に頼るのは依存してしまうことになる。

これはドメインの重大なルールが本来記述されるべき場所以外に漏れ出してしまっている状態にある。

## ユニークキー制約との付き合い方

ドメインのルールを守るための具体的な方法としてユニークキー制約に頼ることは得策ではないが、まったく使えないわけではない。

セーフティネットにはなるので、よりソフトウェアの安全性を高めるために、コードとユニークキー制約を併用するとよい。

# トランザクションによる防衛

データの整合性を保つために利用される一般的な手段としてはデータベースのトランザクション機能が挙げられる。

割愛

## ロックについて

トランザクションは一貫性を保証するためにデータをロックするが、ロックの範囲は常に念頭におく必要がある。

トランザクションによるロックは可能な限り小さくすべき。広範囲に渡るとそれに慰霊して処理が失敗する確率が高まる。

ロックを挟める一つの指標として挙げられるのは、一度のトランザクションで保存するオブジェクトを１つに限定し、さらにそのオブジェクトをなるべく小さくすること。

