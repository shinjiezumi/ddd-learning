# 集約とは

オブジェクト指向プログラミングでは複数のオブジェクトがまとめられ、ひとつの意味をもったオブジェクトが構築される。

こうしたオブジェクトのグループには維持されるべき不変条件が存在する。

不変条件は常に維持されることが求められるが、オブジェクトのデータを変更しようとする操作を無制限に受け入れてしまうとそれは難しくなるので、オブジェクトの操作には秩序が必要になる。

集約は不変条件を維持する単位として切り出され、オブジェクトの操作に秩序をもたらす。

集約には境界とルートが存在する。集約の境界は集約に何が含まれるのかを定義するための境界で、ルートは集約に含まれる特定のオブジェクト。

外部からの集約に対する操作は全てルートを経由して行われる。集約の境界内に存在するオブジェクトを外部にさらけ出さないことで、集約内の不変条件を維持できるようにしている。

## 集約の基本的構造
集約は関連するオブジェクト同士を線で囲う境界として定義される。

TODO: 図

集約の外部から境界の内部のオブジェクトを操作してはならない。集約を操作するための直接のインターフェースとなるオブジェクトは集約ルート(Aggregate Root)と呼ばれるオブジェクトに限定され、集約内部のオブジェクトに対する変更は、集約ルートが責任をもって行うことで集約内部の不変条件を保つ。

例えば`UserName`を直接操作してよいのは集約ルートである`User`のみで、ユーザー名の変更は`User`オブジェクトに依頼をする形で変更しなくてはならない。

```php
$userName = new UserName('NewName');

// NG
$user->name = $userName;

// OK
$user->changeName($userName);
```

いずれの操作もその結果に違いはないが、`changeName`といったメソッドを用意することで渡された引数のチェックが行える。

TODO: 図

サークル集約に含まれるサークル名などを操作して良いのは集約ルートである`Circle`で、サークルのメンバーを追加する場合も同様で集約ルート越しに操作する必要がある。

ユーザー集約はサークル集約に含まれないため、ユーザー集約の情報を変更するような操作はサークル集約からは行わないが、サークルにメンバーとしてユーザーを追加するといった関連の操作はサークル集約が行う。

```php
$circle->members->add($member);
```

上記のようなコードは集約のルールに違反している。サークル集約の内部に含まれる`members`は集約ルートである`Circle`が操作すべきで、以下のように`Circle`オブジェクトにメソッドを追加することが推奨される。

```php
class Circle
{
    private CircleId $id;
    private User $owner;
    private array $members;
    
    public function join(User $member)
    {
        if (count($this->members) >= 29) {
            throw new CircleFullException($this->id);
        }
        
        $this->members[] = $member;
    }
}
```

`join`メソッドはユーザーをメンバーとして追加する際に上限チェックを行い、またメンバーを追加する際には`join`
メソッドを呼び出す以外に方法はなく、結果としてメンバーを追加する際には上限チェックが行われ、30名までという不変条件は常に維持されることになる。