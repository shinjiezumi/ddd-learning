# サービスとは

ソフトウェア開発において、サービスはクライアントのために何かを行うオブジェクトで、ドメイン駆動設計においては大きく２つ。

１つはドメインのためのサービスで、もうひとつがアプリケーションのためのサービス。前者はドメインサービス、後者はアプリケーションサービスと呼ぶ。

## ドメインサービスとは

値オブジェクトやエンティティにはふるまいが記述される。

が、システムには値オブジェクトやエンティティに記述すると不自然になってしまう振る舞いが存在し、それを解決するのがドメインサービス。

例えばユーザー名の重複判定など。

```php
class UserService
{
    public function exists(User $user) :bool
    {
        // 重複を確認する処理
        return true;
    }
}
```

ドメインサービスは値オブジェクトやエンティティと異なり、自身のふるまいを変更するようなインスタンス特有の状態をもたないオブジェクト。

また、ドメインサービスにふるまいを移設すると、ドメインオブジェクトが属性しか持たない無口なオブジェクトになってしまう。(ドメイン貧血症)

## 可能な限りドメインサービスを避ける

ふるまいをエンティティや値オブジェクトに定義するか、ドメインサービスに定義するかに迷った際は、まずエンティティや値オブジェクトに定義することを考える。

# エンティティや値オブジェクトと共にユースケースを組み立てる

ドメインサービスは値オブジェクトやエンティティと組み合わせて利用される。

ドメインサービスはドメインモデルのコード上の表現であり、括りは値オブジェクトやエンティティと同じ。

`UserService`参照。

## ドメインサービスの基準

ドメインサービスはドメインモデル上の表現であり、括りとしては値オブジェクトやエンティティと同じ。

そのため、ドメインサービスは入出力を伴う処理は取り扱わないようにすべきという考えもある。

データストアの存在が存在しないドメインにとって、入出力操作はアプリケーションを構築するうえで追加されたもので、アプリケーションの関心事。

ただし、これは人による。

「ユーザーの重複」という考えが、ドメインに基づくものであれば、入出力操作でもドメインサービスに記述することは問題ないと考える人もいる。（必要最低限の範囲で）

# 物流システムにおけるドメインサービスの例

物流システムでは、荷物を拠点から直接配送するのではなく、拠点から配送先の近くの拠点に輸送してから配送する。

```mermaid
flowchart LR
    id1(物流拠点) -- 輸送(transport) --> id2(物流拠点) -- 配送(delivery) -->  id3(配送先)
```

## 物流拠点のふるまいとして定義する

物流拠点はドメインの重要な概念でエンティティとして定義する

```php 
class PhysicalDistributionBase
{
    public function ship(Baggage $baggage): Baggage
    {
        // 略
        return $baggage;
    }

    public function receive(Baggage $baggage): void
    {
        // 略
    }
}
```

物流拠点には出庫(ship)と入庫(receive)というふるまいがある。出庫と入庫はセットで取り扱われるべき活動。

出庫していない架空の荷物を入庫してしまうといった誤りを防ぐ必要がある。

こういった処理をエンティティに記述するのは違和感があるので、ドメインサービスとして定義する。

```php 
class TransportService
{

    public function transport(PhysicalDistributionBase $from, PhysicalDistributionBase $to, Baggage $baggage): void
    {
        $shippedBaggage = $from->ship($baggage);
        $to->receive($shippedBaggage);

        // 略
    }
}
```

## ドメインサービスの命名規則

ドメインサービスの命名規則は以下３つに分けられる

- ドメインの概念
- ドメインの概念 + Service
- ドメインの概念 + DomainService

サービスはドメインの活動が対象となりやすく、動詞に基づいて命名されることが多い。

どれも誤りではないが、2つ目が採用されることが多い


