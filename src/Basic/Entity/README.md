# エンティティとは

エンティティはドメインモデルを実装したドメインオブジェクトで、値オブジェクトとの違いは、同一性によって識別されるか否か。

例えばシステムのユーザーなど、登録した後にユーザーの情報が変更されてもユーザー自体が変わるわけではない。

これはユーザーが同一性で識別されているためで、これらオブジェクトをエンティティと呼ぶ。

# エンティティの性質

- 可変である
- 同じ属性であっても区別される
- 同一性により区別される

## 可変である

不変である値オブジェクトに対して、エンティティは可変なオブジェクト。

人々がもつ年齢や身長といった属性が変化するように、エンティティの属性は変化することが許容されている。

以下はユーザー名を変更するケース。

```php
class User
{
    private string $name;

    public function __construct(string $name)
    {
        $this->changeName($name);
    }

    public function changeName(string $name)
    {
        if (mb_strlen($name) < 3) {
            throw new \InvalidArgumentException("invalid name");
        }

        $this->name = $name;
    }
```

`changeName`メソッドを通じて名前を表す属性を変更でき、メソッド名によりそのふるまいが何であるかが語られ、ガード節によって異常な値が設定されることはない。

値オブジェクトは不変の性質があるため交換(代入)によって変更を実現していたが、エンティティは交換による変更を行わない。

エンティティの属性を変化させたい時は、その振る舞いを通じて属性を変更する。

なお、全ての属性を可変にする必要はなく、あくまで必要に応じて可変にすることが許されているだけ。

可変なオブジェクトは厄介な存在なので可能な限り不変にしておくことが良い。

## 同じ属性であっても区別される

値オブジェクトは同じ属性であれば同じものと扱われていたのに対し、エンティティは同じ属性であっても区別される。

例えば、姓名という属性は同じでも、同じ人物を指しているとは断定できない。こういったエンティティ同士を区別するために識別子（Identity）が利用される。

`User`オブジェクト参照

## 同一性をもつ

例えばユーザーの属性が変わっても、変更前と変更後で別ユーザーになることはないため、ユーザーには同一性があると言える。

同じように属性が異なっていても同じものとしてみなす必要があるものが存在し、これらは全て同一性により識別されるオブジェクト。

その同一性を判断するために識別子を利用する。

`User`オブジェクト参照

# エンティティの判断基準としてのライフサイクルと連続性

値オブジェクトとエンティティはドメインの概念を表現するオブジェクトとして似通っている。

エンティティにするかを判断する基準は、ライフサイクルが存在しそこに連続性が存在するかどうか。

ライフサイクルを持たない、またライフサイクルを表現することが無意味である場合は、ひとまず値オブジェクトとして取り扱うとよい。

# 値オブジェクトとエンティティのどちらにもなりうるモデル

全く同じ概念を指していても、システムによっては値オブジェクトにすべきときもあれば、エンティティにすべきときもある。

例えば車にとってタイヤはパーツで、交換可能なので値オブジェクトとして表現可能な概念。

一方、タイヤ製造工場にとっては、タイヤにはロットや製造年月日などがあり個体を識別することは重要なので、エンティティとして表現するのが正しい。

同じものでも、それを取り巻く環境によってモデルに対する捉え方は変わる。

ソフトウェアにとって最適な表現方法がどちらになるのかは意識しておく。

# ドメインオブジェクトを定義するメリット

エンティティ、値オブジェクトは、いずれもドメインモデルの表現であるドメインオブジェクトで以下のメリットがある。

- コードのドキュメント性が高まる
- ドメインにおける変更をコードに伝えやすくする

## コードのドキュメント性が高まる

仕様書などのドキュメントはマクロな要件については有効であっても、ミクロな要件については無力であることが多い。

また、内容が間違っていてもソフトウェアが動作しなくなるような問題を引き起こさないため、間違いに気づきにくい。

これらドキュメントが役に立たないのであれば、開発者はコードを頼ることになる。

ドメインオブジェクトとして実装しておくことで、そこに存在する（「ユーザー名は3文字以上」などの）ルールを確認することができる。

なお、ドメイン駆動設計ではドメインについて学び、ドメインモデルを作り上げるところからはじめ、それをドメインオブジェクトとして実装する。

## ドメインにおける変更をコードに伝えやすくする

ドメインオブジェクトにルールや振る舞いを記述することは、ドメインにおける変更をコードに伝えやすくする効果がある。

例えばユーザー名のルールが変更されたとして、ルールが散らばっているとすべてに影響が出るのに対し、ドメインオブジェクトの修正のみで完結する。

ドメインは日々変化していくものなので、変化への対応も頻繁に求められる。