# 値オブジェクトとは

システムには必要とされる処理にしたがって、そのシステムならではの値の表現がある。 ドメイン駆動設計ではこのようなシステム固有の値を現したオブジェクトを値オブジェクトと呼ぶ。

# 値オブジェクトの性質

- 不変である
- 交換が可能である
- 等価性によって比較される

## 不変である

以下のような実装は避ける。

```php
$fullName = new FullName('taro', 'yamada');
$fullName->changeLastName('sato');
```

生成したインスタンスをメソッドに引き渡したら、いつの間にか状態を変更されて意図せぬ挙動となる場合がある。

この解決策として状態を不変にする。いつの間にか変更されることが問題ならそもそも変更できないようにしてしまえば良い。

状態を変更できないというのはプログラムをシンプルにする可能性を秘めた制約でもある。

- 並行・並列処理を伴うプログラムを比較的に容易に実装できる
- 状態が変更されないオブジェクトであればひとつのオブジェクトをキャッシュして使い回すことでリソースの節約が可能

### 不変にすることによるデメリット

デメリットは、オブジェクトの値を一部変更したい時でも新たなインスタンスを生成する必要がある点。

状態を変更できるときに比べてパフォーマンスの寒天で不利になる。

## 交換が可能である

インスタンスの再生成による変更のみ許容する。

```php
$fullName = new FullName('taro', 'yamada');
$fullName = new FullName('taro', 'sato');
```

## 等価性によって比較される

値オブジェクトはシステム固有の値で、その属性(プロパティ)を取り出して比較するのではなく、 値と同じように値オブジェクト同士が比較できるようにする方が自然な記述になる。

比較用の`equals`メソッドを実装するのが一般的。

```php
$nameA = new FullName('taro', 'yamada');
$nameB = new FullName('taro', 'sato');

$compareResult = $nameA->equals($nameB);
```

このような実装にすると、値オブジェクトにプロパティが追加されても呼び出し元の修正が不要で保守性も高くなる。

# 値オブジェクトにする基準

どこまでを値オブジェクトにするかは難しい。

`FullName`のプロパティである`$lastName`と`$firstName`を、値オブジェクトにすることは間違いではない。

値オブジェクトにする/しないの一つの判断基準として、「そこにルールが存在しているか」という点と「それ単体で取扱いたいか」という点を考えてみる。

姓だけや名だけをシステムとして利用するシーンがなければ不要ともいえる。

逆に値オブジェクトにする場合は、姓と名を同じもの(`Name`)とするか、別物(`LastName`/`FirstName`)とするかも検討が必要。

重要なのは値オブジェクトを避けることではなく、値オブジェクトにすべきかを見極めて、そうすべきと判断したら大胆に実行すべき。

それは実装中に発見した場合でもドメインモデルとしてフィードバックしていく。

# 振る舞いを持った値オブジェクト

値オブジェクトはデータを保持するコンテナではなく、振る舞いを持つことができるオブジェクト。

お金を加算する時は通貨を揃える必要があるため、同一かどうかチェックする。

また、値オブジェクトは不変であるため、計算を行った結果は新たなインスタンスとして返却する。

```php
class Money
{
    private $amount;
    private $currency;
    
    public function Add(Money $arg): Money
    {
        if ($this->currency !== $arg->currency) {
            throw new InvalidArgumentException("通貨が異なります");
        }
    
        return new Money($this->amount + $arg->amount, $this->currency);
    }
}
```

バグは思い違いから発生するもの。計算処理にルールを記述しそれにそぐわない操作をはじくようにして、システマチックに誤った操作を防止する。

値オブジェクトはただのデータ構造を指しているわけではなく、オブジェクトに対する操作を振る舞いとして一処ににまとめることで、値オブジェクトは自身に関するルールをまとめたドメインオブジェクトらしさを帯びる。